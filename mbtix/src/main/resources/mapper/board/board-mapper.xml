<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="board">
    
    <select id="selectBoardList" resultType="board">
    	SELECT B.* , U.NICKNAME
    	FROM BOARD B
    	JOIN USERS U ON B.USER_ID = U.USER_ID
    	LEFT JOIN MBTI_BOARD MB ON B.BOARD_ID = MB.BOARD_ID
		<where>
			<if test="mbtiName != null and mbtiName != ''">
				MBTI_NAME = #{mbtiName}	
			</if>
		</where>
    </select>
    
    <resultMap type="board" id="boardResultMap" autoMapping="true">
    	<id property="boardId" column="BOARD_ID"/>
    	<collection property="images" javaType="java.util.List" ofType="string">
    		<result column="FILE_NAME"/>
    	</collection>
    </resultMap>
    
    <select id="selectBoard" resultMap="boardResultMap">
    	SELECT B.* , U.NICKNAME, F.FILE_NAME
    	FROM BOARD B
    	JOIN USERS U ON B.USER_ID = U.USER_ID
    	LEFT JOIN "FILE" F ON REF_ID = BOARD_ID AND F.CATEGORY_ID = B.CATEGORY_ID    	    	
    	WHERE BOARD_ID = #{boardId}
    </select>
    
    
    
    <insert id="insertBoard">
    	INSERT INTO BOARD(BOARD_ID, CATEGORY_ID, TITLE, CONTENT, USER_ID)
    	VALUES(BOARD_SEQ.NEXTVAL , #{categoryId}, #{title}, #{content}, 8)
    	
    	<selectKey keyProperty="boardId" resultType="int" order="AFTER">
    		SELECT BOARD_SEQ.CURRVAL FROM DUAL
    	</selectKey>
    </insert>
    
    <insert id="insertMbtiBoard">
    	INSERT INTO MBTI_BOARD
    	VALUES(#{boardId} , #{mbtiName})
    </insert>
    
    <update id="incrementView">
	    UPDATE BOARD
	    SET "VIEW" = "VIEW" + 1
	    WHERE BOARD_ID = #{boardId}
	</update>
	
	<insert id="insertReport">
		INSERT INTO REPORTS
		VALUES (REPORTS_SEQ.NEXTVAL, #{userId}, #{targetUserNum}, #{reason}, DEFAULT, DEFAULT, DEFAULT, #{reportCategory})
	</insert>
    
    <insert id="insertBoardImage">
    	INSERT INTO "FILE" 
    	VALUES (FILE_SEQ.NEXTVAL, #{fileName} , #{refId}, #{categoryId})
    </insert>
    
    <!-- 
    	1. 댓글 등록
    	2. 댓글 조회     
     -->
     
     <!-- 
        COMMENT_ID, USER_ID, CONTENT, BOARD_ID 
     	댓글번호, 유저번호, 내용, 게시글 번호 등록
      -->
     <insert id="insertComment">
     	INSERT INTO BOARD_COMMENT(COMMENT_ID, USER_ID, CONTENT, BOARD_ID )
     	VALUES (BOARD_COMMENT_SEQ.NEXTVAL, #{userId}, #{content}, #{boardId})
     </insert>
     
     <select id="getComments" resultType="boardComment">
     	SELECT 
   			NVL(NICKNAME, '익명') NICKNAME,
     		CONTENT,
     		CREATE_AT,
     		COMMENT_ID,
     		PARENT_ID
     	FROM BOARD_COMMENT BC
     	LEFT JOIN USERS U ON BC.USER_ID = U.USER_ID     	
     	WHERE BOARD_ID = #{boardId}
     </select>
     
     
    
    
</mapper>