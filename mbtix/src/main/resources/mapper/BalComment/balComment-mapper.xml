<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="BalCommentMapper">

  <!-- 댓글 목록 조회 -->
  <select id="selectCommentsByBal" parameterType="long"
          resultType="com.kh.mbtix.balComment.model.dto.BalCommentDto$BalComment">
    SELECT 
        c.COMMENT_ID AS commentId,
        c.BAL_ID     AS balId,
        c.USER_ID    AS userId,
        u.NICKNAME   AS userName,
        v.SNAP_MBTI  AS mbti,          
        c.CONTENT    AS content,
        TO_CHAR(c.CREATE_AT,'HH24:MI') AS createAt
    FROM BAL_COMMENT c
    JOIN USERS u ON c.USER_ID = u.USER_ID
    JOIN BAL_VOTE v ON c.BAL_ID = v.BAL_ID AND c.USER_ID = v.USER_ID
    WHERE c.BAL_ID = #{balId}
    ORDER BY c.CREATE_AT ASC
  </select>

  <!-- 댓글 작성 -->
  <insert id="insertComment" parameterType="map">
    INSERT INTO BAL_COMMENT (COMMENT_ID, BAL_ID, USER_ID, CONTENT)
    VALUES (SEQ_BAL_COMMENT.NEXTVAL, #{balId}, #{userId}, #{content})
  </insert>

  <!-- 댓글 삭제 (작성자 본인만) -->
  <delete id="deleteComment" parameterType="map">
    DELETE FROM BAL_COMMENT
    WHERE COMMENT_ID = #{commentId}
      AND USER_ID = #{userId}
  </delete>

</mapper>
