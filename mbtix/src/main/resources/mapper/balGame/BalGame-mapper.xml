<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.mbtix.balgame.mapper.BalGameMapper">

  <!-- =========================
       ResultMaps (DTO constructor mapping)
       ========================= -->

  <!-- BalGameDtos.GameDto(Long gameId, String title, String startAt, String isActive) -->
  <resultMap id="GameDtoMap" type="com.kh.mbtix.balgame.model.dto.BalGameDtos$GameDto">
    <constructor>
      <arg column="GAME_ID"   javaType="long"/>
      <arg column="TITLE"     javaType="string"/>
      <arg column="START_AT"  javaType="string"/>
      <arg column="IS_ACTIVE" javaType="string"/>
    </constructor>
  </resultMap>

  <!-- BalGameDtos.OptionDto(Long optionId, Long gameId, String label, String textContent, String imageUrl) -->
  <resultMap id="OptionDtoMap" type="com.kh.mbtix.balgame.model.dto.BalGameDtos$OptionDto">
    <constructor>
      <arg column="OPTION_ID"    javaType="long"/>
      <arg column="GAME_ID"      javaType="long"/>
      <arg column="LABEL"        javaType="string"/>
      <arg column="TEXT_CONTENT" javaType="string"/>
      <arg column="IMAGE_URL"    javaType="string"/>
    </constructor>
  </resultMap>

  <!-- BalGameDtos.PastListRes.PastCard(Long gameId, String title, String startAt) -->
  <resultMap id="PastCardMap" type="com.kh.mbtix.balgame.model.dto.BalGameDtos$PastListRes$PastCard">
    <constructor>
      <arg column="GAME_ID"  javaType="long"/>
      <arg column="TITLE"    javaType="string"/>
      <arg column="START_AT" javaType="string"/>
    </constructor>
  </resultMap>

  <!-- =========================
       SELECTs
       ========================= -->

  <!-- 오늘의 게임 1건 (ACTIVE='Y' 최신) → GameDto -->
  <select id="selectTodayGame" resultMap="GameDtoMap">
    SELECT
      g.BAL_ID        AS GAME_ID,
      g.TITLE         AS TITLE,
      TO_CHAR(g.CREATE_DATE,'YYYY-MM-DD') AS START_AT,
      g.ACTIVE        AS IS_ACTIVE
    FROM BAL_GAME g
    WHERE g.ACTIVE = 'Y'
    ORDER BY g.CREATE_DATE DESC
    FETCH FIRST 1 ROWS ONLY
  </select>

  <!-- 특정 게임의 옵션 목록 → OptionDto -->
  <!-- 인터페이스 파라미터명이 gameId 라고 가정(@Param("gameId") 권장) -->
  <select id="selectOptionsByGameId" parameterType="long" resultMap="OptionDtoMap">
    SELECT
      o.OPTION_ID     AS OPTION_ID,
      o.BAL_ID        AS GAME_ID,
      o.LABEL         AS LABEL,
      o.TEXT_CONTENT  AS TEXT_CONTENT,
      o.IMAGE_URL     AS IMAGE_URL
    FROM BAL_OPTION o
    WHERE o.BAL_ID = #{gameId}
    ORDER BY o.LABEL
  </select>

  <!-- 지난 게임 목록 (페이지) → PastCard -->
  <select id="selectPastGamesPaged" resultMap="PastCardMap">
    SELECT
      g.BAL_ID        AS GAME_ID,
      g.TITLE         AS TITLE,
      TO_CHAR(g.CREATE_DATE,'YYYY-MM-DD') AS START_AT
    FROM BAL_GAME g
    WHERE g.ACTIVE = 'N'
       OR TRUNC(g.CREATE_DATE) &lt; TRUNC(SYSDATE)
    ORDER BY g.CREATE_DATE DESC, g.BAL_ID DESC
    OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
  </select>

  <!-- 지난 게임 총 개수 -->
  <select id="countPastGames" resultType="int">
    SELECT COUNT(*)
    FROM BAL_GAME g
    WHERE g.ACTIVE = 'N'
       OR TRUNC(g.CREATE_DATE) &lt; TRUNC(SYSDATE)
  </select>

  <!-- 옵션별 총 투표수/비율 (통계용 Map) -->
  <select id="selectOptionTotals" parameterType="long" resultType="map">
    SELECT
      o.LABEL AS LABEL,
      COUNT(*) AS CNT,
      RATIO_TO_REPORT(COUNT(*)) OVER () AS PCT
    FROM BAL_VOTE v
    JOIN BAL_OPTION o ON v.OPTION_ID = o.OPTION_ID
    WHERE v.BAL_ID = #{gameId}
    GROUP BY o.LABEL
    ORDER BY o.LABEL
  </select>

  <!-- 옵션별 MBTI 분포 (통계용 Map) -->
  <select id="selectOptionMbti" parameterType="long" resultType="map">
    SELECT
      o.LABEL     AS LABEL,
      v.SNAP_MBTI AS MBTI,
      COUNT(*)    AS CNT,
      RATIO_TO_REPORT(COUNT(*)) OVER (PARTITION BY o.LABEL) AS PCT
    FROM BAL_VOTE v
    JOIN BAL_OPTION o ON v.OPTION_ID = o.OPTION_ID
    WHERE v.BAL_ID = #{gameId}
    GROUP BY o.LABEL, v.SNAP_MBTI
    ORDER BY o.LABEL, MBTI
  </select>

  <!-- 유저 MBTI 코드 (스냅샷용) -->
  <select id="selectUserMbtiCode" parameterType="long" resultType="string">
    SELECT MBTI_CODE
    FROM MEMBER
    WHERE USER_ID = #{userId}
  </select>

  <!-- =========================
       INSERTs
       ========================= -->

  <!-- 투표 등록 -->
  <!-- 인터페이스 시그니처: (Long gameId, Long optionId, Long userId, String snapMbti) -->
  <insert id="insertVote">
    INSERT INTO BAL_VOTE (BAL_ID, OPTION_ID, USER_ID, SNAP_MBTI, CREATED_AT)
    VALUES (#{gameId}, #{optionId}, #{userId}, #{snapMbti}, SYSDATE)
  </insert>

</mapper>
